<!DOCTYPE html>
<html>
<head>
  <title>Pee Tracker 💦</title>
  <link rel="stylesheet" href="./style.css">

</head>
<body>
  <div class="container">
    <h1>Pee Tracker 💦</h1>

    <div id="authSection">
      <div id="loginForm">
        <h2>Welcome Back!</h2>
        <div id="loginError" class="error-message" style="display:none;"></div>
        <input id="loginEmail" type="email" placeholder="Enter your email" required />
        <input id="loginPassword" type="password" placeholder="Enter your password" required />
        <button onclick="login()">Login</button>
        <p>New user? <a href="#" onclick="toggleAuthForms()">Register here</a></p>
      </div>

      <div id="registerForm" style="display:none;">
        <h2>Join the Community!</h2>
        <div id="registerError" class="error-message" style="display:none;"></div>
        <input id="registerName" type="text" placeholder="Enter your full name" required />
        <input id="registerEmail" type="email" placeholder="Enter your email" required />
        <input id="registerPassword" type="password" placeholder="Choose a strong password" required />
        <button onclick="register()">Create Account</button>
        <p>Already have an account? <a href="#" onclick="toggleAuthForms()">Login here</a></p>
      </div>
    </div>

    <div id="appSection" style="display:none;">
      <h2>Welcome, <span id="username"></span>! 👋</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="todayCount">0</div>
          <div class="stat-label">Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="weekCount">0</div>
          <div class="stat-label">This Week</div>
        </div>
      </div>

      <div class="last-pee-info" id="lastPeeInfo">
        <div>Last pee: <span class="last-pee-time" id="lastPeeTime">Never recorded</span></div>
      </div>

      <button onclick="logPee()" class="pee-button">🚽 I Just Peed!</button>
      <button onclick="logout()" class="btn-secondary">Logout</button>
      
      <h3>🏆 Leaderboard (Last 7 Days)</h3>
      <ul id="leaderboard"></ul>
    </div>
  </div>

  <script>
    // Check login status when the page loads
    window.onload = function() {
        fetch('/session')
            .then(res => res.json())
            .then(data => {
                if (data.loggedIn) {
                    showApp(data.name);
                } else {
                    showAuth();
                }
            });
    };

    function showError(elementId, message) {
        const errorDiv = document.getElementById(elementId);
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    function validateName(name) {
        if (name.length < 2) {
            return "Name must be at least 2 characters long";
        }
        if (!/^[a-zA-Z\s'-]+$/.test(name)) {
            return "Name can only contain letters, spaces, hyphens, and apostrophes";
        }
        if (name.trim() !== name) {
            return "Name cannot start or end with spaces";
        }
        return null;
    }

    function toggleAuthForms() {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        loginForm.style.display = loginForm.style.display === 'none' ? 'block' : 'none';
        registerForm.style.display = registerForm.style.display === 'none' ? 'block' : 'none';
        
        // Clear error messages when switching forms
        document.getElementById('loginError').style.display = 'none';
        document.getElementById('registerError').style.display = 'none';
    }

    function register() {
        const name = document.getElementById('registerName').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value.trim();

        if (!name || !email || !password) {
            showError('registerError', 'Please fill all fields!');
            return;
        }

        // Validate name
        const nameError = validateName(name);
        if (nameError) {
            showError('registerError', nameError);
            return;
        }

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showError('registerError', 'Please enter a valid email address');
            return;
        }

        // Validate password strength
        if (password.length < 6) {
            showError('registerError', 'Password must be at least 6 characters long');
            return;
        }

        const button = event.target;
        button.textContent = 'Creating Account...';
        button.classList.add('loading');

        fetch('/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name,
                    email,
                    password
                })
            }).then(res => {
                if (!res.ok) {
                    return res.text().then(text => {
                        throw new Error(text)
                    });
                }
                return res.json();
            })
            .then(data => {
                showApp(data.name);
            })
            .catch(err => {
                showError('registerError', err.message);
            })
            .finally(() => {
                button.textContent = 'Create Account';
                button.classList.remove('loading');
            });
    }

    function login() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        
        if (!email || !password) {
            showError('loginError', 'Please enter email and password!');
            return;
        }

        const button = event.target;
        button.textContent = 'Logging in...';
        button.classList.add('loading');

        fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email,
                    password
                })
            }).then(res => {
                if (!res.ok) {
                    return res.text().then(text => {
                        throw new Error(text)
                    });
                }
                return res.json();
            })
            .then(data => {
                showApp(data.name);
            })
            .catch(err => {
                showError('loginError', err.message);
            })
            .finally(() => {
                button.textContent = 'Login';
                button.classList.remove('loading');
            });
    }

    function logout() {
        fetch('/logout', {
            method: 'POST'
        }).then(() => {
            showAuth();
        });
    }

    function logPee() {
        const button = event.target;
        button.textContent = '🚽 Logging...';
        button.classList.add('loading');

        fetch('/pee', {
            method: 'POST'
        }).then(res => {
            if (!res.ok) {
                alert('Something went wrong. You may be logged out.');
                showAuth();
            } else {
                loadDashboardData();
                loadLeaderboard();
            }
        }).finally(() => {
            button.textContent = '🚽 I Just Peed!';
            button.classList.remove('loading');
        });
    }

    function loadDashboardData() {
        fetch('/dashboard-stats')
            .then(res => res.json())
            .then(data => {
                document.getElementById('todayCount').textContent = data.todayCount || 0;
                document.getElementById('weekCount').textContent = data.weekCount || 0;
                
                if (data.lastPeeTime) {
                    const lastPeeDate = new Date(data.lastPeeTime);
                    const now = new Date();
                    const timeDiff = now - lastPeeDate;
                    
                    let timeAgo;
                    if (timeDiff < 60000) {
                        timeAgo = 'Just now';
                    } else if (timeDiff < 3600000) {
                        timeAgo = `${Math.floor(timeDiff / 60000)} minutes ago`;
                    } else if (timeDiff < 86400000) {
                        timeAgo = `${Math.floor(timeDiff / 3600000)} hours ago`;
                    } else {
                        timeAgo = `${Math.floor(timeDiff / 86400000)} days ago`;
                    }
                    
                    document.getElementById('lastPeeTime').textContent = timeAgo;
                } else {
                    document.getElementById('lastPeeTime').textContent = 'Never recorded';
                }
            })
            .catch(err => {
                console.error('Error loading dashboard data:', err);
            });
    }

    function loadLeaderboard() {
        fetch('/leaderboard')
            .then(res => res.json())
            .then(data => {
                const ul = document.getElementById('leaderboard');
                ul.innerHTML = '';
                data.forEach((user, index) => {
                    const li = document.createElement('li');
                    
                    const rank = document.createElement('span');
                    rank.className = 'leaderboard-rank' + (index === 0 ? ' first' : '');
                    rank.textContent = index + 1;
                    
                    const name = document.createElement('span');
                    name.textContent = user.name;
                    
                    const count = document.createElement('span');
                    count.textContent = `${user.count} pees`;
                    count.style.fontWeight = 'bold';
                    count.style.color = '#667eea';
                    
                    li.appendChild(rank);
                    li.appendChild(name);
                    li.appendChild(count);
                    ul.appendChild(li);
                });
            });
    }

    // UI transition functions
    function showApp(name) {
        document.getElementById('username').textContent = name;
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('appSection').style.display = 'block';
        loadDashboardData();
        loadLeaderboard();
    }

    function showAuth() {
        document.getElementById('authSection').style.display = 'block';
        document.getElementById('appSection').style.display = 'none';
        
        // Clear form fields
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
        document.getElementById('registerName').value = '';
        document.getElementById('registerEmail').value = '';
        document.getElementById('registerPassword').value = '';
    }

    // Add Enter key support for forms
    document.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            if (document.getElementById('loginForm').style.display !== 'none') {
                login();
            } else if (document.getElementById('registerForm').style.display !== 'none') {
                register();
            }
        }
    });
  </script>
</body>
</html>